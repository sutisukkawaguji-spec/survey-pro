<!DOCTYPE html>
<html lang="th">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SurveyPro">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/854/854878.png">
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Survey Solo Pro (Complete)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/tokml@0.4.0/tokml.js"></script>

    <style>
        :root { --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom); }
        body { 
            font-family: 'Sarabun', sans-serif; 
            overflow: hidden; 
            background-color: #f3f4f6; 
            /* จัดการพื้นที่หน้าจอให้เต็มและหลบรอยบาก */
            height: 100dvh; 
            padding-top: var(--safe-top);
            padding-bottom: var(--safe-bottom);
            display: flex; flex-direction: column;
        }
        
        .map-full { flex: 1; width: 100%; z-index: 0; }
        
        #top-bar { position: absolute; top: calc(10px + var(--safe-top)); left: 10px; right: 10px; z-index: 1000; pointer-events: none; }
        .top-row { display: flex; gap: 8px; pointer-events: auto; margin-bottom: 8px; }
        
        .control-btn { background: white; width: 45px; height: 45px; border-radius: 12px; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.15); cursor: pointer; font-size: 18px; color: #444; border: none; flex-shrink: 0; }
        .control-btn:active { transform: scale(0.95); background: #f0f0f0; }

        .search-group { flex: 1; background: white; height: 45px; border-radius: 12px; display: flex; align-items: center; padding: 0 5px; gap: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.15); pointer-events: auto; position: relative; }
        .search-input { flex: 2; min-width: 0; height: 100%; border: none; outline: none; padding-left: 5px; font-size: 14px; background: transparent; }
        .filter-select { flex: 1.5; min-width: 0; height: 35px; border: 1px solid #eee; border-radius: 8px; font-size: 11px; color: #555; outline: none; background: #f9fafb; }

        #search-results { position: absolute; top: 55px; left: 0; right: 0; z-index: 1001; background: white; border-radius: 12px; max-height: 250px; overflow-y: auto; display:none; box-shadow: 0 10px 25px rgba(0,0,0,0.2); border: 1px solid #eee; }
        #search-results.active { display: block; }

        #status-bar { background: rgba(255, 255, 255, 0.95); border: 1px solid #ddd; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; color: #333; display: inline-flex; align-items: center; gap: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); cursor: pointer; }
        #job-counter { background: #10b981; color: white; padding: 1px 6px; border-radius: 10px; font-size: 10px; margin-left: 5px; }

        .fab-col { position: absolute; bottom: calc(30px + var(--safe-bottom)); right: 10px; display: flex; flex-direction: column; gap: 12px; z-index: 900; transition: 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .fab-col.sheet-open { bottom: calc(180px + var(--safe-bottom)); }

        .btn-fab { width: 55px; height: 55px; border-radius: 50%; background: white; color: #333; box-shadow: 0 4px 10px rgba(0,0,0,0.25); display: flex; justify-content: center; align-items: center; font-size: 22px; border: none; transition: 0.2s; cursor: pointer; }
        .btn-fab.active-gps { background: #2563eb !important; color: white !important; }

        #sheet { 
            position: absolute; bottom: 0; left: 0; right: 0; 
            background: white; border-radius: 24px 24px 0 0; 
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); 
            z-index: 2000; max-height: 85vh; display: flex; flex-direction: column;
            padding-bottom: var(--safe-bottom); /* ยกหลบแถบ iPhone */
            box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
        }
        #sheet.active { transform: translateY(0); }
        #sheet.minimized { transform: translateY(calc(100% - 145px - var(--safe-bottom))); }

        .sheet-header { padding: 15px; border-bottom: 1px solid #f0f0f0; display: flex; justify-content: space-between; align-items: center; background: white; border-radius: 24px 24px 0 0; flex-shrink: 0; cursor: pointer; }
        .sheet-controls { padding: 10px 15px; background: white; border-bottom: 1px solid #f0f0f0; flex-shrink: 0; }
        .sheet-content { padding: 15px; background: white; overflow-y: auto; flex: 1; }

        .dimmed-layer { opacity: 0.3; filter: grayscale(100%); }
        .leaflet-routing-container { display: none !important; }
        #loading-overlay { position: fixed; inset: 0; z-index: 9999; display: none; align-items: center; justify-content: center; background: rgba(0,0,0,0.7); color: white; flex-direction: column; }
    </style>
</head>
<body>

<div id="loading-overlay">
        <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-white mb-4"></div>
        <div id="loading-text">กำลังประมวลผล...</div>
    </div>

    <div id="top-bar">
        <div class="top-row justify-between items-center px-1 mb-2">
            <div id="status-bar" onclick="openToolsMenu()">
                <i class="fa-solid fa-user-gear text-blue-600"></i> 
                <span id="user-display">ตั้งค่า</span> 
                <span id="job-counter">0/0</span>
            </div>
            
            <div class="flex gap-2">
                <button class="control-btn text-blue-600" onclick="document.getElementById('fileInput').click()">
                    <i class="fa-solid fa-folder-open"></i>
                </button>
                <button class="control-btn text-purple-600" onclick="toggleViewMode()" id="btn-view">
                    <i class="fa-solid fa-draw-polygon"></i>
                </button>
                <button class="control-btn text-gray-700" onclick="toggleBaseMap()">
                    <i class="fa-solid fa-layer-group"></i>
                </button>
            </div>
        </div>

        <div class="top-row px-1">
            <div class="search-group w-full"> <input type="text" id="inp-search" placeholder="ค้นหาชื่อ หรือ หมายเหตุ..." class="search-input" onkeyup="doSearch()">
                <select id="sel-amphoe" onchange="onAmphoeChange()" class="filter-select"><option value="">อ.ทั้งหมด</option></select>
                <select id="sel-tambon" onchange="filterMap()" class="filter-select"><option value="">ต.ทั้งหมด</option></select>
                <div id="search-results"></div>
            </div>
        </div>
    </div>

    <input type="file" id="fileInput" accept=".json,.geojson,.txt,*/*" class="hidden" onchange="importData(this)">
    <div id="map" class="map-full"></div>

    <div id="fab-container" class="fab-col">
        <button class="btn-fab bg-gray-800 text-white" onclick="openToolsMenu()"><i class="fa-solid fa-gear"></i></button>
        <button class="btn-fab bg-blue-500 text-white" onclick="findNearestNewJob()"><i class="fa-solid fa-crosshairs"></i></button>
        <button id="btn-gps" class="btn-fab bg-white text-blue-600" onclick="toggleGPSFollow()">
            <i class="fa-solid fa-location-arrow"></i>
        </button>
    </div>

    <div id="sheet">
        <div class="sheet-header" onclick="toggleSheetSize()">
            <div>
                <h2 id="sheet-title" class="text-lg font-bold text-gray-800">รายละเอียด</h2>
                <p id="sheet-meta" class="text-xs text-gray-500">-</p>
            </div>
            <button onclick="closeSheet(event)" class="w-10 h-10 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center hover:bg-red-100 hover:text-red-500">
                <i class="fa-solid fa-times text-xl"></i>
            </button>
        </div>

        <div class="sheet-controls">
            <div class="grid grid-cols-2 gap-3">
                <button onclick="navGoogle()" class="bg-white border border-gray-200 text-gray-700 py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2 shadow-sm">
                    <i class="fab fa-google text-red-500"></i> Google Maps
                </button>
                <button id="btn-nav-start" onclick="startNav()" class="bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2 shadow-md">
                    <i class="fa-solid fa-route"></i> นำทาง
                </button>
                <button id="btn-nav-cancel" onclick="stopNav()" class="hidden bg-red-500 hover:bg-red-600 text-white py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2 shadow-md">
                    <i class="fa-solid fa-stop-circle"></i> ยกเลิก
                </button>
            </div>
        </div>

        <div class="sheet-content">
            <div class="space-y-4">
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-xs font-bold text-gray-500 ml-1">ชื่อแปลง / เลขทะเบียน</label>
                        <button onclick="viewJsonData()" class="text-[10px] bg-gray-100 text-gray-600 px-2 py-1 rounded hover:bg-gray-200 border border-gray-200 transition">
                            <i class="fa-solid fa-code"></i> ข้อมูลดิบ
                        </button>
                    </div>
                    <input type="text" id="sheet-name" class="w-full p-3 border border-gray-300 rounded-xl bg-white outline-none focus:border-green-500 font-bold" disabled>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-500 ml-1">รายละเอียด / หมายเหตุ</label>
                    <textarea id="sheet-note" rows="4" class="w-full p-3 border border-gray-300 rounded-xl bg-white outline-none focus:border-green-500" disabled></textarea>
                </div>
                
                <div id="action-buttons">
                    <button id="btn-save" onclick="saveData()" class="w-full bg-green-600 text-white py-4 rounded-xl font-bold shadow-lg text-lg flex items-center justify-center gap-2 hidden">
                        <i class="fa-solid fa-save"></i> <span>บันทึกข้อมูล</span>
                    </button>
                    <button id="btn-edit" onclick="enableEdit()" class="w-full bg-yellow-500 text-white py-4 rounded-xl font-bold shadow-lg text-lg flex items-center justify-center gap-2 hidden">
                        <i class="fa-solid fa-pen-to-square"></i> <span>แก้ไขข้อมูล</span>
                    </button>
                </div>

                <button onclick="deleteJob()" class="w-full bg-red-50 text-red-500 py-3 rounded-xl text-sm font-bold mt-2 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-trash-can"></i> ลบรายการนี้
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- IndexedDB ---
        const DB_NAME='SurveyDB_Complete_V1'; const DB_VER=1; let db;
        function initDB(){return new Promise((res,rej)=>{const r=indexedDB.open(DB_NAME,DB_VER); r.onupgradeneeded=(e)=>{if(!e.target.result.objectStoreNames.contains('jobs'))e.target.result.createObjectStore('jobs',{keyPath:'id'})}; r.onsuccess=(e)=>{db=e.target.result;res(db)}; r.onerror=()=>rej();});}
        function saveJobToDB(j){return new Promise((res,rej)=>{const t=db.transaction('jobs','readwrite'); t.objectStore('jobs').put(j); t.oncomplete=()=>res(); t.onerror=()=>rej();});}
        function deleteJobFromDB(id){return new Promise((res,rej)=>{const t=db.transaction('jobs','readwrite'); t.objectStore('jobs').delete(id); t.oncomplete=()=>res(); t.onerror=()=>rej();});}
        function getAllJobs(){return new Promise((res)=>{if(!db)return res([]); const t=db.transaction('jobs','readonly'); const r=t.objectStore('jobs').getAll(); r.onsuccess=()=>res(r.result||[]); r.onerror=()=>res([]);});}
        function clearDB(){return new Promise((res)=>{const t=db.transaction('jobs','readwrite'); t.objectStore('jobs').clear(); t.oncomplete=()=>res();});}

        let map, userMarker, routingControl;
        let dbJobs=[], markersGroup=L.layerGroup();
        let selectedJobId=null, currentUser={name:'นายช่าง',category:'ทั่วไป'}, categories=['ทั่วไป','ตรวจสอบ','เร่งด่วน'];
        let viewMode='original', isNavigating=false, isFollowing=false;
        let speechSynth = window.speechSynthesis;
        let navInterval = null;
        
        const maps = { street: L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {maxZoom:20}), hybrid: L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {maxZoom:20}) };
        let currentBaseMap='hybrid';

        window.addEventListener('load', async()=>{
            showLoading(true,'โหลดระบบ...'); await initDB();
            try {
                const p=localStorage.getItem('survey_profile_v16'); const c=localStorage.getItem('survey_cats_v16');
                if(c) categories=JSON.parse(c); if(p) currentUser=JSON.parse(p);
                dbJobs = await getAllJobs();
            } catch(e){ localStorage.clear(); }
            showLoading(false); initApp();
        });

        function showLoading(s,t){ document.getElementById('loading-overlay').style.display=s?'flex':'none'; if(t)document.getElementById('loading-text').innerText=t; }

        function initApp(){
            updateUserInfo();
            map = L.map('map',{zoomControl:false, attributionControl: false}).setView([13.7,100.5],6);
            maps.hybrid.addTo(map); markersGroup.addTo(map);
            updateAmphoeDropdown(); renderMap(true); 
            
            navigator.geolocation.watchPosition(p=>{
                const latlng=[p.coords.latitude, p.coords.longitude];
                if(!userMarker) userMarker=L.marker(latlng,{icon:L.divIcon({className:'bg-blue-500 w-4 h-4 rounded-full border-2 border-white shadow'})}).addTo(map);
                else userMarker.setLatLng(latlng);
                if(isFollowing && !isNavigating) map.setView(latlng, 18);
            }, e=>{}, {enableHighAccuracy:true});

            map.on('dragstart', () => { if(isFollowing) toggleGPSFollow(false); });
        }

        function updateUserInfo(){ document.getElementById('user-display').innerText=currentUser.name; }
        
        function updateCounter() {
            const catJobs = dbJobs.filter(j => j.category === currentUser.category);
            const doneCount = catJobs.filter(j => j.status === 'done').length;
            document.getElementById('job-counter').innerText = `${doneCount}/${catJobs.length}`;
        }

        function toggleGPSFollow(state) {
            isFollowing = (state !== undefined) ? state : !isFollowing;
            const btn = document.getElementById('btn-gps');
            if(isFollowing) {
                btn.classList.add('active-gps');
                if(userMarker) { map.setView(userMarker.getLatLng(), 18); Swal.fire({toast:true, position:'top', icon:'info', title:'ติดตามตำแหน่ง', timer:1000, showConfirmButton:false}); } 
                else Swal.fire('รอ GPS...','','info');
            } else btn.classList.remove('active-gps');
        }

        function getFilteredJobs() {
            const search = document.getElementById('inp-search').value.toLowerCase();
            const amphoe = document.getElementById('sel-amphoe').value;
            const tambon = document.getElementById('sel-tambon').value;
            return dbJobs.filter(j => {
                const matchCat = j.category === currentUser.category;
                const p = j.properties;
                const txt = search;
                const matchS = txt === "" || (p.name || "").toString().toLowerCase().includes(txt) || (p.note || "").toString().toLowerCase().includes(txt);
                const matchA = amphoe === "" || (p.amphoe || p.AMPH_NAME) == amphoe;
                const matchT = tambon === "" || (p.tambon || p.TUMB_NAME) == tambon;
                return matchCat && matchS && matchA && matchT;
            });
        }

        function renderMap(fitBounds=false){
            markersGroup.clearLayers();
            const filtered = getFilteredJobs();
            const group=L.featureGroup();
            filtered.slice(0,1500).forEach(job=>{
                let layer;
                let color=job.status==='done'?'#10b981':(job.status==='navigating'?'#f97316':'#ef4444');
                let fill=job.status==='done'?0.4:0.2;
                if(viewMode==='original' && job.geometry && (job.geometry.type.includes('Polygon'))){
                    layer=L.geoJSON(job.geometry,{style:{color:color,weight:2,fillOpacity:fill}});
                } else {
                    let iconUrl=job.status==='done'?'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png':'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png';
                    if(job.status==='navigating') iconUrl='https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png';
                    layer=L.marker([job.lat,job.lng],{icon:L.icon({iconUrl,iconSize:[25,41],iconAnchor:[12,41]})});
                }
                if(layer){
                    layer.jobId=job.id;
                    if(isNavigating && job.id!==selectedJobId) layer.on('add',()=>layer.getElement()?.classList.add('dimmed-layer'));
                    layer.on('click',()=>openSheet(job));
                    markersGroup.addLayer(layer); group.addLayer(layer);
                }
            });
            if(fitBounds && filtered.length>0) try{map.fitBounds(group.getBounds(),{padding:[50,50]})}catch(e){}
            updateCounter();
        }

        function speak(text) { if('speechSynthesis' in window) { const u = new SpeechSynthesisUtterance(text); u.lang = 'th-TH'; speechSynth.speak(u); } }

        function startNav() {
            if(!userMarker) return Swal.fire('GPS ไม่พร้อม', '', 'warning');
            const job=dbJobs.find(j=>j.id===selectedJobId); if(!job)return;
            viewMode='pin'; document.getElementById('btn-view').innerHTML='<i class="fa-solid fa-map-pin"></i>';
            
            isNavigating=true; job.prevStatus=job.status; job.status='navigating'; renderMap();
            map.fitBounds(L.latLngBounds([userMarker.getLatLng(), [job.lat, job.lng]]), {padding: [100, 100]});

            document.getElementById('btn-nav-start').classList.add('hidden');
            document.getElementById('btn-nav-cancel').classList.remove('hidden');
            document.getElementById('sheet').classList.add('minimized');

            if(routingControl)try{map.removeControl(routingControl)}catch(e){}
            try{
                routingControl=L.Routing.control({
                    waypoints:[userMarker.getLatLng(), L.latLng(job.lat, job.lng)],
                    createMarker:()=>null, lineOptions:{styles:[{color:'#2563eb',weight:6,opacity:0.9}]},
                    show:false, addWaypoints:false
                }).addTo(map);
                speak("เริ่มการนำทาง");
                if(navInterval) clearInterval(navInterval);
                navInterval = setInterval(() => {
                    if(!userMarker) return;
                    const d = map.distance(userMarker.getLatLng(), [job.lat, job.lng]);
                    if(d < 100) {
                        speak("ถึงที่หมายแล้ว");
                        stopNav(); 
                        document.getElementById('sheet').classList.remove('minimized');
                        document.getElementById('sheet').classList.add('active');
                        Swal.fire({toast:true, icon:'success', title:'ถึงแล้ว!', text:'กรอกข้อมูลได้เลย', timer:2000, showConfirmButton:false});
                    }
                }, 3000);
            }catch(e){}
        }

        function stopNav() {
            isNavigating=false; 
            if(routingControl)try{map.removeControl(routingControl)}catch(e){} routingControl=null;
            if(navInterval) clearInterval(navInterval);
            document.getElementById('btn-nav-start').classList.remove('hidden');
            document.getElementById('btn-nav-cancel').classList.add('hidden');
            const job=dbJobs.find(j=>j.id===selectedJobId); if(job)job.status=job.prevStatus||'done';
            renderMap();
        }

        function openSheet(job) {
            selectedJobId=job.id;
            const p=job.properties;
            document.getElementById('sheet-title').innerText=p.name||'รายละเอียด';
            document.getElementById('sheet-meta').innerText=`${p.amphoe||p.AMPH_NAME||'-'} / ${p.tambon||p.TUMB_NAME||'-'}`;
            document.getElementById('sheet-name').value=p.name||'';
            document.getElementById('sheet-note').value=p.note||'';
            
            // Logic ปุ่ม Save/Edit
            const btnSave = document.getElementById('btn-save');
            const btnEdit = document.getElementById('btn-edit');
            
            if(job.status === 'done') {
                btnSave.classList.add('hidden');
                btnEdit.classList.remove('hidden');
                toggleInputs(false); // ล็อกช่องพิมพ์
            } else {
                btnSave.classList.remove('hidden');
                btnEdit.classList.add('hidden');
                toggleInputs(true); // ปลดล็อก
            }

            document.getElementById('fab-container').classList.add('sheet-open');
            document.getElementById('sheet').classList.remove('minimized');
            document.getElementById('sheet').classList.add('active');
            
            if(!isNavigating) map.flyTo([job.lat,job.lng],16);
        }

        function toggleInputs(enabled) {
            document.getElementById('sheet-name').disabled = !enabled;
            document.getElementById('sheet-note').disabled = !enabled;
        }

        function enableEdit() {
            toggleInputs(true);
            document.getElementById('btn-save').classList.remove('hidden');
            document.getElementById('btn-edit').classList.add('hidden');
        }

        function closeSheet(e) {
            if(e)e.stopPropagation();
            document.getElementById('sheet').classList.remove('active');
            document.getElementById('sheet').classList.remove('minimized');
            document.getElementById('fab-container').classList.remove('sheet-open');
            if(isNavigating) stopNav();
            selectedJobId=null;
        }

        function toggleSheetSize(){ document.getElementById('sheet').classList.toggle('minimized'); }

        function findNearestNewJob() {
            if(!userMarker) return Swal.fire('รอ GPS','','info');
            const filteredJobs = getFilteredJobs().filter(j => j.status !== 'done');
            if(filteredJobs.length===0) return Swal.fire('เยี่ยม','ไม่มีงานค้างในพื้นที่นี้','success');
            let min=Infinity, near=null; const u=userMarker.getLatLng();
            filteredJobs.forEach(j=>{ const d=map.distance(u,[j.lat,j.lng]); if(d<min){min=d; near=j;} });
            if(near) { 
                openSheet(near); 
                document.getElementById('sheet').classList.add('minimized');
                map.fitBounds(L.latLngBounds([u, [near.lat, near.lng]]), {padding:[80,80]});
                Swal.fire({toast:true, icon:'success', title:'งานถัดไป', text:Math.round(min)+' ม.', timer:1500, showConfirmButton:false}); 
            }
        }

        function viewJsonData() {
            const job = dbJobs.find(j => j.id === selectedJobId);
            if(!job) return;
            let html = '<div class="text-left text-xs max-h-[60vh] overflow-y-auto"><table class="w-full border-collapse">';
            const sortedKeys = Object.keys(job.properties).sort();
            sortedKeys.forEach(k => {
                if(k !== 'name' && k !== 'note' && k !== 'date') {
                    html += `<tr class="border-b"><td class="font-bold p-2 text-gray-500 bg-gray-50 w-1/3">${k}</td><td class="p-2 text-gray-800 break-words">${job.properties[k]}</td></tr>`;
                }
            });
            html += '</table></div>';
            Swal.fire({ title: 'ข้อมูลต้นฉบับ', html: html, width: '90%', confirmButtonText: 'ปิด', confirmButtonColor: '#4b5563' });
        }

        function importData(input) {
            const f=input.files[0]; if(!f)return;
            showLoading(true,'นำเข้า...');
            const r=new FileReader();
            r.onload=async(e)=>{
                try{
                    let raw=e.target.result.trim(); if(raw.charCodeAt(0)===0xFEFF)raw=raw.slice(1);
                    const json=JSON.parse(raw);
                    let feats=(json.type==="FeatureCollection")?json.features:(Array.isArray(json)?json:[json]);
                    const tx=db.transaction('jobs','readwrite');
                    const newJobs=[];
                    feats.forEach(f=>{
                         const p=f.properties||f; let geom=f.geometry;
                         if(!geom && (f.lat||p.lat)) geom={type:'Point',coordinates:[parseFloat(f.lng||p.lng),parseFloat(f.lat||p.lat)]};
                         if(!geom) return;
                         let lat,lng;
                         if(geom.type==='Point'){ lng=geom.coordinates[0]; lat=geom.coordinates[1]; }
                         else { try{const l=L.geoJSON(geom); const c=l.getBounds().getCenter(); lat=c.lat; lng=c.lng;}catch(err){return;} }
                         const job={
                             id:'IMP-'+Math.random().toString(36).substr(2,9), lat,lng,geometry:geom, 
                             status:'waiting', category:currentUser.category, 
                             properties:{ ...p, name:p.REG_ID||p.name||'นำเข้า', note:p.REMARK||p.note||'' } 
                         };
                         tx.objectStore('jobs').put(job); newJobs.push(job);
                    });
                    tx.oncomplete=()=>{ dbJobs=[...dbJobs,...newJobs]; updateAmphoeDropdown(); renderMap(true); showLoading(false); Swal.fire('สำเร็จ',`เพิ่ม ${newJobs.length} แปลง`,'success'); };
                } catch(e) { showLoading(false); Swal.fire('Error',e.message,'error'); }
            };
            r.readAsText(f); input.value='';
        }

        async function saveData() {
            const job=dbJobs.find(j=>j.id===selectedJobId);
            if(job){
                if(isNavigating) stopNav();
                job.status='done'; 
                job.properties.name=document.getElementById('sheet-name').value;
                job.properties.note=document.getElementById('sheet-note').value;
                job.properties.date=new Date().toISOString().split('T')[0];
                await saveJobToDB(job); 
                renderMap();
                closeSheet();
                Swal.fire({toast:true,icon:'success',title:'บันทึกแล้ว',timer:1000,showConfirmButton:false});
            }
        }

        // --- แก้ไข: ลบแล้วหมุดหายทันที ---
        function deleteJob(){ 
            Swal.fire({title:'ลบรายการนี้?', text:'ข้อมูลจะหายไปถาวร', icon:'warning', showCancelButton:true, confirmButtonColor:'#ef4444'}).then(async(r)=>{
                if(r.isConfirmed){
                    await deleteJobFromDB(selectedJobId); // ลบจาก DB
                    dbJobs=dbJobs.filter(j=>j.id!==selectedJobId); // ลบจาก RAM
                    renderMap(); // วาดใหม่
                    closeSheet();
                }
            });
        }
        
        function navGoogle() { const j=dbJobs.find(x=>x.id===selectedJobId); window.open(`https://www.google.com/maps/dir/?api=1&destination=${j.lat},${j.lng}`, '_blank'); }
        
        function updateAmphoeDropdown(){
            const s=new Set(); dbJobs.filter(j=>j.category===currentUser.category).forEach(j=>{const a=j.properties.amphoe||j.properties.AMPH_NAME; if(a)s.add(a)});
            const el=document.getElementById('sel-amphoe'); el.innerHTML='<option value="">อ.ทั้งหมด</option>';
            Array.from(s).sort().forEach(a=>el.innerHTML+=`<option value="${a}">${a}</option>`);
            document.getElementById('sel-tambon').innerHTML='<option value="">ต.ทั้งหมด</option>';
        }
        function onAmphoeChange(){
            const v=document.getElementById('sel-amphoe').value; const s=new Set();
            dbJobs.filter(j=>j.category===currentUser.category&&(j.properties.amphoe||j.properties.AMPH_NAME)===v).forEach(j=>{const t=j.properties.tambon||j.properties.TUMB_NAME; if(t)s.add(t)});
            const el=document.getElementById('sel-tambon'); el.innerHTML='<option value="">ต.ทั้งหมด</option>';
            Array.from(s).sort().forEach(t=>el.innerHTML+=`<option value="${t}">${t}</option>`);
            renderMap(true);
        }
        function filterMap(){ renderMap(true); }
        function toggleViewMode(){ viewMode=viewMode==='original'?'pin':'original'; document.getElementById('btn-view').innerHTML=viewMode==='pin'?'<i class="fa-solid fa-map-pin"></i>':'<i class="fa-solid fa-draw-polygon"></i>'; renderMap(); }
        function toggleBaseMap(){ map.removeLayer(maps[currentBaseMap]); currentBaseMap=currentBaseMap==='hybrid'?'street':'hybrid'; map.addLayer(maps[currentBaseMap]); }
        
        // --- แก้ไข: เพิ่มปุ่มปิด (X) ในหน้าตั้งค่า ---
        function openToolsMenu(){ 
            let catOptions=''; categories.forEach(c=>{catOptions+=`<option value="${c}" ${c===currentUser.category?'selected':''}>${c}</option>`});
            Swal.fire({
                title:'ตั้งค่า', 
                html:`
                <button onclick="Swal.close()" class="absolute top-3 right-4 text-gray-400 text-2xl">×</button>
                <div class="text-left space-y-3 pt-4">
                    <div class="p-3 border rounded bg-gray-50">
                        <label class="text-xs">ชื่อ</label>
                        <input id="set-name" class="w-full border p-1" value="${currentUser.name}">
                        <label class="text-xs mt-2 block">หมวดงาน</label>
                        <div class="flex gap-2">
                            <select id="set-cat" class="w-full border p-1 rounded">${catOptions}</select>
                            <button onclick="addCat()" class="bg-gray-200 px-2">+</button>
                        </div>
                    </div>
                    <button onclick="clearAll()" class="w-full text-red-600 border p-2 bg-red-50 text-xs font-bold">ล้างข้อมูล</button>
                    <div class="p-3 border rounded border-blue-200 bg-blue-50 text-center">
                        <label class="text-xs">ส่งออก</label>
                        <div class="flex justify-center gap-2 mt-1">
                            <button onclick="doExport('xlsx')" class="bg-green-600 text-white px-2 py-1 rounded text-xs">Excel</button>
                            <button onclick="doExport('kml')" class="bg-blue-600 text-white px-2 py-1 rounded text-xs">KML</button>
                        </div>
                    </div>
                </div>`, 
                showConfirmButton:true, 
                confirmButtonText:'บันทึก', 
                preConfirm:()=>{ 
                    currentUser.name=document.getElementById('set-name').value; 
                    currentUser.category=document.getElementById('set-cat').value; 
                    localStorage.setItem('survey_profile_v16',JSON.stringify(currentUser)); 
                    updateUserInfo(); updateAmphoeDropdown(); renderMap(); 
                } 
            });
        }

        function addCat(){ Swal.fire({input:'text',title:'เพิ่มหมวด'}).then(r=>{if(r.value){categories.push(r.value); localStorage.setItem('survey_cats_v16',JSON.stringify(categories)); Swal.close(); openToolsMenu(); }}); }
        function clearAll(){ Swal.fire({title:'ยืนยันล้าง?',text:'ข้อมูลทั้งหมดจะหายไป', icon:'warning', showCancelButton:true,confirmButtonColor:'red'}).then(async(r)=>{if(r.isConfirmed){await clearDB(); dbJobs=[]; renderMap(); Swal.fire('ล้างแล้ว','','success');}});}
        function doExport(type){ const data=dbJobs.filter(j=>j.category===currentUser.category && j.status==='done'); if(data.length===0)return Swal.fire('ไม่มีข้อมูลที่เสร็จ','','warning'); const f=`SURVEY_${currentUser.category}`; if(type==='xlsx'){const r=data.map(j=>({ID:j.id,Name:j.properties.name,Note:j.properties.note})); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(r),"Data"); XLSX.writeFile(wb,f+'.xlsx');} if(type==='kml'){const g={type:"FeatureCollection",features:data.map(j=>({type:"Feature",properties:{name:j.properties.name},geometry:j.geometry}))}; download(tokml(g),f+'.kml','application/vnd.google-earth.kml+xml');} }
        function download(c,n,m){ const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([c],{type:m})); a.download=n; a.click(); }
        
        function doSearch(){ 
            renderMap(); 
            const hits = getFilteredJobs();
            const res = document.getElementById('search-results');
            res.innerHTML=''; 
            if(hits.length>0) res.classList.add('active'); else res.classList.remove('active'); 
            hits.slice(0,10).forEach(j=>{
                const name = j.properties.name || '(ไม่มีชื่อ)';
                const note = j.properties.note || '';
                res.innerHTML += `
                    <div class="p-3 border-b cursor-pointer hover:bg-gray-50" onclick="openSheetFromSearch('${j.id}')">
                        <div class="text-sm font-bold text-gray-800">${name}</div>
                        ${note ? `<div class="text-xs text-gray-500 truncate">${note}</div>` : ''}
                    </div>`;
            }); 
        }
        
        function openSheetFromSearch(id){ 
            const j=dbJobs.find(x=>x.id===id); 
            if(j){ openSheet(j); document.getElementById('sheet').classList.add('minimized'); document.getElementById('search-results').classList.remove('active'); document.getElementById('inp-search').value=''; if(userMarker) map.fitBounds(L.latLngBounds([userMarker.getLatLng(), [j.lat, j.lng]]), {padding:[80,80]}); } 
        }
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
              navigator.serviceWorker.register('./service-worker.js')
                .then(reg => console.log('PWA Ready!', reg))
                .catch(err => console.log('PWA Failed', err));
            });
        }
    </script>
</body>
</html>
